(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{1053:function(e,t,a){var n={"./geojson.json":422,"./table-schema.json":1054,"./topojson.json":423};function r(e){var t=i(e);return a(t)}function i(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=i,e.exports=r,r.id=1053},1160:function(e,t){},1161:function(e,t){},1163:function(e,t,a){},1165:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),i=a(56),o=a.n(i),l=a(30),s=(a(476),a(162)),c=a(23),u=a(24),d=a(26),f=a(25),m=a(27),p=a(6),h=a(2),b=a(5),v=a(86),E="START_MODIFICATION",g={foreignKeyField:null,modificationIndex:0,modificationList:null},w=Object(v.a)(g,{SET_STEP:function(e,t){if("0"===t.payload.id)return g},START_MODIFICATION:function(e,t){var a=t.payload;e.modificationList=a,e.modificationIndex=0},REVALIDATE_ROWS_SUCCESS:function(e,t){var a=t.payload,n=a.originalValue,r=a.fixedValues;e.modificationList.forEach(function(t,a){"currency|year|reporting"===t.field&&t.value.split("|")[1]===""+n&&(e.modificationList[a]=Object(b.a)({},e.modificationList[a],{fixed:!0,fixedStatus:"autoFixed",unchangable:!0,fixedValues:{currency:t.value.split("|")[0],year:r.year,reporting:t.value.split("|")[2]}}))})},REVALIDATE_ROWS_FAILURE:function(e,t){var a=t.payload,n=a.fixedValues,r=a.rowNumbers;e.modificationList.forEach(function(t,a){var i=t.errors.map(function(e){return e.rowNumber});if("currency|year|reporting"===t.field&&Object(p.isEqual)(i,r)){var o=t.value.split("|")[0]+"|"+n.year+"|"+t.value.split("|")[2],l=e.modificationList.find(function(e){return e.value===o});l&&l.index!==a?e.modificationList[a]=Object(b.a)({},e.modificationList[a],{fixed:!0,fixedStatus:"fixInOther",unchangable:!0,fixedValues:{currency:t.value.split("|")[0],year:n.year,reporting:t.value.split("|")[2]}}):e.modificationList[a]=Object(b.a)({},e.modificationList[a],{fixed:!1,fixedStatus:"notFixed",unchangable:!1,value:o,fixedValues:null})}})},HIDE_MODIFICATION:function(e,t){e.modificationIndex=0},SELECT_ERROR:function(e,t){var a=t.payload;e.modificationIndex=a.index},GO_NEXT_ERROR:function(e,t){e.modificationIndex=e.modificationIndex+1},GO_PREV_ERROR:function(e,t){e.modificationIndex>0&&(e.modificationIndex=e.modificationIndex-1)},SUBMIT_MODIFICATION:function(e,t){var a=t.payload;e.modificationList[a.index]=Object(b.a)({},e.modificationList[a.index],a,{fixed:!0})}}),y=a(53),O="INIT_TABLES",C={},R=Object(v.a)(C,{INIT_TABLES:function(e){return C},FETCH_TABLES_SUCCESS:function(e,t){var a=t.payload,n={},r={};Object.keys(a).forEach(function(e){n[e]=Object(y.b)(a[e],function(e){return Object(p.mapValues)(e,function(e,t){return"year"===t?+e:""===e?null:e})}),r[e]=n[e].length}),e.referenceTables=n,e.originalLength=r},DELETE_TABLE_ROW:function(e,t){var a=t.payload,n=a.data,r=a.resourceName,i=e.referenceTables[r].slice();i=i.filter(function(e){return!n.some(function(t){return Object(p.isEqual)(e,t)})}),e.referenceTables[r]=i},ADD_TABLE_ROW:function(e,t){var a=t.payload,n=a.data,r=a.resourceName,i=e.referenceTables[r].slice();i.splice.apply(i,[i.length,0].concat(Object(s.a)(n))),e.referenceTables[r]=i}}),x="SET_STEP",S="HIDE_MODIFICATION",j="SELECT_ERROR",T="SHOW_CONFIRMATION_MODAL",k="HIDE_CONFIRMATION_MODAL",N=function(e){return function(t){"0"===e.id&&t({type:O}),t({type:x,payload:e})}},_=[{id:"0",name:"Upload file",title:"Choose a file"},{id:"1",name:"Schema Validation",title:"Schema validation against datapackage"},{id:"2",name:"Error Fixing",title:"Fix errors by fields"},{id:"3",name:"Export/Publish Data",title:"Export or Publish your data to Github"}],F={steps:_,isModalDisplay:!1,selectedStep:_[0],isModification:!1,fixedIndex:[]};var A={},I=Object(v.a)(A,{SET_STEP:function(e,t){if("0"===t.payload.id)return A},IMPORT_FLOWS:function(e,t){return t.payload},UPDATE_FLOWS:function(e,t){var a=t.payload,n=a.errors,r=a.fixedValues,i=Object.keys(r);n.forEach(function(t){i.forEach(function(a){var n=e.data[0].indexOf(a);e.data[t.rowNumber-1][n]=r[a]})})}}),V=a(10),D=a.n(V),L=a(54),M=a(15),B=a(247),U=a(460),P=a(63),H={id:0,flow:1,unit:2,year:3,species_bullions:4,transport_type:5,statistical_period:6,partner_sum:7,world_trade_type:8,notes:9,source:10,reporting:11,partner:12,"export_import|special_general":13,"currency|year|reporting":14},G={partner:"RICname",reporting:"RICname",currency:"modified_currency",export_import:"modified_export_import",special_general:"modified_special_general"},K=["slug","export_import","special_general","reporting","partner","original_name","currency","year"],W=/[^a-zA-Z0-9]+/g,q=function(e,t){return t.map(function(t){return e[t]?e[t].trim().split(" ").map(function(e){return Object(p.capitalize)(e.replace(W,""))}).join(""):null},"").filter(function(e){return e}).join("_")},Q=function(e){return q(e,function(e){return["website"===e.source_category?"editor":"author","name","country","volume_date","volume_number","pages"]}(e))},z=["name","editor","country","volumn_number","shelf_number"],Y=a(75),J=a(40),X=a(248),Z=a.n(X),$=a(249),ee=a(102),te="FETCH_DATAPACKAGE_SUCCESS",ae="FETCH_TABLES_SUCCESS",ne="FETCH_TABLES_FAILURE",re="FETCH_BRANCHES_SUCCESS",ie="LOGOUT_USER",oe="LOGIN_CREATE_BRANCH_SUCCESS",le="LOGIN_CREATE_BRANCH_FAILURE",se="UPDATE_REMOTE_FILES_REQUEST",ce="UPDATE_REMOTE_FILES_LOG",ue="UPDATE_REMOTE_FILES_SUCCESS",de="UPDATE_REMOTE_FILES_FAILURE",fe={};var me="VALIDATE_TABLE_REQUEST",pe="VALIDATE_TABLE_SUCCESS",he="VALIDATE_TABLE_FAILURE",be="VALIDATE_HEADER_REQUEST",ve="VALIDATE_HEADER_SUCCESS",Ee="VALIDATE_HEADER_FAILURE",ge=function(e){return"string"===typeof e?e:e.join("|")},we=function(e,t,a){var n=t.fields,r=t.foreignKeys,i=n.map(function(e){return e.name}),o=["source","export_import","special_general","currency"],l=n.filter(function(e){return-1===o.indexOf(e.name)}),s=r.map(function(e){return ge(e.fields)}),c=["ERROR_FORMAT","ERROR_FOREIGN_KEY"],u=l.reduce(function(e,t){return Object(b.a)({},e,Object(M.a)({},t.name,{name:t.name,schema:t,errorType:"ERROR_FORMAT",errors:[]}))},{}),d=r.reduce(function(e,t){var a=ge(t.fields);return Object(b.a)({},e,Object(M.a)({},a,Object(b.a)({name:a},t,{errorType:"ERROR_FOREIGN_KEY",errors:[]})))},{});return a.forEach(function(t){var a=e[t.rowNumber-1],n=t.rowNumber,r=t.originalRowNumber;c.forEach(function(e){var l=t.errors.find(function(t){return t.type===e});l&&("ERROR_FORMAT"===e?i.forEach(function(t,r){l.errors.forEach(function(i){if(i.columnNumber===r+1&&-1===o.indexOf(t)){var l={rowNumber:n,errorType:e,columnNumber:i.columnNumber,field:t,value:a[r],message:i.message};u[t].errors.push(l)}})}):"ERROR_FOREIGN_KEY"===e&&s.forEach(function(t){l.errors.forEach(function(o){var l=ge(o.columnName);if(l===t){var s=o.columnName.map(function(e){var t=i.indexOf(e);return a[t]}),c={rowNumber:n,originalRowNumber:r,errorType:e,columnName:o.columnName,field:l,value:s.join("|"),message:o.message};d[t].errors.push(c)}})}))})}),Object.keys(u).forEach(function(e){u[e].errors.length||delete u[e]}),Object.keys(d).forEach(function(e){d[e].errors.length||delete d[e]}),u.reporting||u.partner?u:Object(b.a)({},u,d)},ye={resourceName:"flows",schemaFeedback:null,headerFeedback:null,descriptor:null};var Oe=function(e){return e.schemaValidation.resourceName},Ce=function(e){return e.schemaValidation.descriptor.resources},Re=/row\s\d*/,xe=Object(B.a)(Oe,Ce,function(e,t){return t.find(function(t){return t.name===e||t.group===e&&t.schema}).schema}),Se=Object(B.a)(Oe,Ce,function(e){return e.referenceTables.referenceTables},function(e,t,a){var n=t.find(function(t){return t.name===e||t.group===e&&t.schema}),r={};return n?n.schema?n.schema.foreignKeys?(n.schema.foreignKeys.forEach(function(e){var t=e.reference.resource;r[t]=a[t]}),r):{}:(console.error("the resource ".concat(n.name," has no schema !")),{}):(console.error("the resource ".concat(e," could not be found!")),{})}),je=function(e){var t=e.className,a=e.modificationList,n=e.onSelectError,i=["","Field","Value","Rows",""],o=a.filter(function(e){return"year"===e.field&&!e.fixed}).map(function(e){return""+e.value});return r.a.createElement("div",{style:{position:"relative",width:"100%",height:"70vh"}},r.a.createElement("div",{className:"action-table ".concat(t)},r.a.createElement("div",{className:"action-table-header"},i.map(function(e,t){return r.a.createElement("div",{key:t,className:"table-cell"},r.a.createElement("span",{className:"Value"===e?"has-text-danger":"has-text-black"},e))})),r.a.createElement("div",{className:"action-table-main"},a.map(function(e,t){var a=e.field,l=e.errors,s=e.originalValue,c=e.value,u=e.message,d=e.fixed,f=e.fixedValues,m=Object(p.values)(f).join("|"),b=Object(p.difference)(K,a.split("|")).length<K.length,v=function(){n(t)},E=!1;return"currency|year|reporting"===e.field&&-1!==o.indexOf(e.value.split("|")[1])&&(E=!0),r.a.createElement("div",{key:t,className:"table-row"},i.map(function(n,i){switch(i){case 0:default:return r.a.createElement("div",{key:i,className:"table-cell"},t+1);case 1:return r.a.createElement("div",{key:i,className:"table-cell"},a);case 2:return r.a.createElement("div",{key:i,className:"table-cell"},s!==c&&r.a.createElement("span",{className:"has-text-danger"},s,"->"),r.a.createElement("span",{className:"has-text-danger"},Object(p.isNull)(c)?"none":c),d&&r.a.createElement("span",{className:"has-text-success"},"->",""===m?"none":m),r.a.createElement(h.HelpPin,null,u));case 3:return r.a.createElement("div",{key:i,className:"table-cell"},r.a.createElement("p",{className:e.fixed?"has-text-success":"has-text-black"},l.length," ",e.fixed&&!b?"rows updated":""),e.fixedReferenceTable&&e.fixedReferenceTable.length>0&&e.fixedReferenceTable.map(function(e,t){return r.a.createElement("p",{key:t,className:"has-text-success"},e.data.length,' row(s) added to "',e.resourceName,'" table')}));case 4:return r.a.createElement("div",{key:i,className:"table-cell"},r.a.createElement(h.Button,{isDisabled:E,isOutlined:!0,isColor:e.fixed?"success":"info",onClick:v},e.fixed?"fixed":"fix error"))}}))}))))},Te=function(e){var t=e.className,a=e.flows,n=e.modificationItem,i=a[0],o=n.errors,l=n.field,s=n.value,c=n.fixedValues;return r.a.createElement("div",{style:{position:"relative",width:"100%",height:"20vh"}},r.a.createElement("div",{className:"action-table ".concat(t)},r.a.createElement("div",{className:"action-table-header"},i.map(function(e,t){var a=-1!==l.split("|").indexOf(e);return r.a.createElement("div",{key:t,className:"table-cell"},r.a.createElement("span",{className:a?"has-text-danger":"has-text-black"},e))})),r.a.createElement("div",{className:"action-table-main",style:{height:"100%"}},o.map(function(e,t){return r.a.createElement("div",{key:t,className:"table-row"},i.map(function(t,n){var i,o=-1!==l.split("|").indexOf(t),u=l.split("|").indexOf(t),d=(""+s).split("|")[u];return"year"===t&&1===u&&(d=a[e.rowNumber-1][n]),c&&o&&(i=0===c[t].length?"none":c[t]),r.a.createElement("div",{key:n,className:"table-cell",style:{wordBreak:"break-all"}},r.a.createElement("span",{className:o?"has-text-danger":"has-text-black"},o?d:a[e.rowNumber-1][n]),i&&r.a.createElement("span",{className:"has-text-success"},"->",i))}))}))))},ke=a(103),Ne=a(461),_e=a.n(Ne),Fe=a(464),Ae=a(104),Ie=function(e){return e.map(function(e){return{label:e,value:e}})},Ve=function(e){var t,a=e.tables,n=e.resourceName,r=e.referenceField,i=e.filter;t=i?a[n].filter(function(e){return e[i.field]!==i.value}).map(function(e){return e[r]}):a[n].map(function(e){return e[r]});var o=Object(p.countBy)(t,function(e){return e});return Object(p.sortBy)(Object(p.toPairs)(o),function(e){var t=Object(Ae.a)(e,2);t[0];return-1*t[1]}).map(function(e){var t=Object(Ae.a)(e,2),a=t[0];t[1];return a}).map(function(e){return{value:e,label:e}})},De=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).getStateFromProps=function(){var e,t=a.props,n=t.fieldDescriptor,r=t.fieldValue,i=new P.Field(n);return i.constraints&&i.constraints.enum&&(e=Ie(i.constraints.enum)),{fieldSchema:i,value:r||"",fieldValid:{valid:!1},options:e,suggestions:[]}},a.validateField=function(e){var t,n=a.state.fieldSchema;try{n.castValue(e),t={value:e,fieldValid:{valid:!0}},a.setState(t),a.props.onChange(Object(b.a)({fieldName:a.state.fieldSchema.name},t))}catch(r){t={value:e,fieldValid:{valid:!1,error:r}},a.setState(t),a.props.onChange(Object(b.a)({fieldName:a.state.fieldSchema.name},t))}},a.handleChange=function(e){e?e&&e.value?a.validateField(e.value):e&&e.target?a.validateField(e.target.value):a.validateField(""):("",a.validateField(""))},a.handleClickCreate=function(){var e=a.props.foreignKeys.find(function(e){return e.fields===a.state.fieldSchema.name});a.handleChange(""),a.props.onClickCreate({referenceMap:{field:a.state.fieldSchema.name,referenceField:e?e.reference.fields:a.state.fieldSchema.name}})},a.onSuggestionsFetchRequested=function(e,t){a.setState({suggestions:function(e,t){var a=e.trim().toLowerCase(),n=a.length;return 0===n?[]:t.filter(function(e){return e.toLowerCase().slice(0,n)===a})}(e,t)})},a.onSuggestionsClearRequested=function(){a.setState({suggestions:[]})},a.handleSuggestionChange=function(e,t){var n=t.newValue;a.validateField(n)},a.renderSuggestion=function(e){return r.a.createElement("div",null,e)},a.state=a.getStateFromProps(),a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"componentDidUpdate",value:function(e){var t=this.props,a=t.fieldDescriptor,n=t.fieldValue,r=t.fixedValue;if("slug"===a.name&&n!==e.fieldValue&&this.validateField(n),r!==e.fixedValue&&!r){var i=this.getStateFromProps();this.setState(Object(b.a)({},i))}}},{key:"renderField",value:function(){var e,t=this,a=this.props,n=a.fieldValue,i=a.foreignKeys,o=a.referenceTables,l=a.showNewReference,s=a.newReference,c=a.isNonchangable,u=a.isValidationField,d=a.suggestedOptions,f=this.state,m=f.fieldSchema,b=f.value,v=f.suggestions,E={placeholder:"",value:b,onChange:this.handleSuggestionChange},g=!1,w=function(e){return{value:e,label:e}};if(-1!==Object(p.findIndex)(i,function(e){return e.fields===m.name||-1!==e.fields.indexOf(m.name)})){var y=Object(p.findIndex)(i,function(e){return e.fields===m.name||-1!==e.fields.indexOf(m.name)}),O=i[y].reference.fields;g=!0,e=Ve({tables:o,resourceName:i[y].reference.resource,referenceField:"object"===typeof O?O[0]:O})}return c?r.a.createElement("span",null,n):g?r.a.createElement("div",null,!l&&!s&&r.a.createElement(ke.a,{isSearchable:!0,isClearable:!0,value:w(b),options:this.state.options,onChange:this.handleChange,onInputChange:function(a){t.setState({options:Object(Fe.a)(e,a,{keys:["label"]}).slice(0,50)})}}),s&&r.a.createElement("div",null,n),(!this.state.value||u)&&r.a.createElement(h.Button,{isColor:"info",onClick:this.handleClickCreate},"Create new item")):m.constraints&&m.constraints.enum?r.a.createElement(ke.a,{isClearable:!0,value:w(b),options:this.state.options,onChange:this.handleChange}):d?r.a.createElement(_e.a,{suggestions:v,onSuggestionsFetchRequested:function(e){var a=e.value;t.onSuggestionsFetchRequested(a,d)},onSuggestionsClearRequested:this.onSuggestionsClearRequested,getSuggestionValue:function(e){return e},renderSuggestion:this.renderSuggestion,inputProps:E}):r.a.createElement(h.Input,{value:b,onChange:this.handleChange})}},{key:"render",value:function(){var e=this.state,t=e.fieldSchema,a=e.fieldValid,n=this.props,i=n.showNewReference,o=n.newReference;return r.a.createElement(h.Field,null,r.a.createElement(h.Label,null,t.name,t.constraints&&t.constraints.required&&r.a.createElement("span",null,"*")),r.a.createElement(h.Control,null,this.renderField()),a&&a.error&&!i&&!o&&r.a.createElement(h.Help,{isColor:"danger"},a.error.message))}}]),t}(r.a.Component),Le=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).hydrateState=function(){return{fixedValue:null,showSolving:!a.props.modificationItem.fixed,fieldValid:null}},a.handleFieldChange=function(e){var t=e.value,n=e.fieldValid;a.props.onTouch(!0),a.setState({fixedValue:t,fieldValid:n})},a.handleSubmitForm=function(){var e=a.props.modificationItem,t=a.state,n=t.fixedValue,r=t.fieldValid;if(r&&r.valid){var i=Object(M.a)({},e.field,n);a.props.onSubmitForm({fixedValues:i})}},a.handleShowSolving=function(){a.props.onTouch(!0),a.setState({showSolving:!0})},a.handleHideSolving=function(){a.props.onTouch(!1),a.setState({showSolving:!1})},a.handleDiscard=function(){a.props.onTouch(!1);var e=a.hydrateState();a.setState(Object(b.a)({},e)),a.props.onDiscard()},a.state=a.hydrateState(),a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"componentDidUpdate",value:function(e){if(this.props.modificationIndex!==e.modificationIndex){var t=this.hydrateState();this.setState(Object(b.a)({},t))}}},{key:"renderOriginal",value:function(){var e=this.props.modificationItem,t=e.value,a=e.message,n=e.field;return r.a.createElement(h.Field,null,r.a.createElement(h.Label,null,'Original value of "',n,'":'),r.a.createElement("strong",null,0===t.length?"none":t),r.a.createElement(h.Help,{isColor:"danger"},a))}},{key:"renderFixed",value:function(){var e=this.props.modificationItem,t=e.fixedValues,a=e.field,n=e.errors,i=0===t[a].length?"none":t[a];return r.a.createElement(h.Field,null,r.a.createElement(h.Label,{className:"has-text-success"},"Fixed with value"),r.a.createElement("strong",{className:"has-text-success"},i),r.a.createElement(h.Help,{isColor:"success"},"total ",n.length," rows affected"),r.a.createElement(h.Button,{isColor:"info",onClick:this.handleShowSolving},"Change this fix"))}},{key:"renderInput",value:function(){var e=this.props,t=e.modificationItem,a=e.fieldDescriptor,n=e.isModificationTouched,i=this.state.fieldValid,o=!i||!i.valid;return r.a.createElement("div",null,r.a.createElement(h.Label,null,"Fix with a new input"),r.a.createElement(De,{isNonchangable:!1,fieldDescriptor:a,fieldValue:t.value,fixedValue:this.state.fixedValue,onChange:this.handleFieldChange}),r.a.createElement(h.Field,{isGrouped:!0},n&&r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",onClick:this.handleDiscard},"Discard modification")),r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",isDisabled:o,onClick:this.handleSubmitForm},"Confirm this fix"))))}},{key:"render",value:function(){var e=this.props.modificationItem.fixed;return r.a.createElement("div",{style:{height:"60vh"}},r.a.createElement("form",null,r.a.createElement(h.Columns,null,r.a.createElement(h.Column,{isSize:"1/2"},this.renderOriginal(),e&&!this.state.showSolving&&this.renderFixed(),this.state.showSolving&&this.renderInput()))))}}]),t}(r.a.Component),Me=function(e){var t=e.resource,a=t.data,n=t.resourceName;return r.a.createElement("div",{style:{height:"40vh",overflow:"auto"}},r.a.createElement("h3",null,a.length,' row(s) add to "',n,'" table'),a.map(function(e){return Object.keys(e).map(function(t){return r.a.createElement("div",{key:t},r.a.createElement(h.Label,null,t,":"),r.a.createElement("p",null,e[t]))})}))},Be={type:0,RICname:1,continent:2,COW_code:3},Ue=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).getStateFromProps=function(){return{fields:a.props.resourceDescriptor.schema.fields.reduce(function(e,t){var a="",n=!0;t.constraints&&t.constraints.enum&&(a=t.constraints.enum[0]);return t.constraints&&t.constraints.required&&!t.constraints.enum&&(n=!1),"type"===t.name&&(a="group"),"continent"===t.name&&(a=""),Object(b.a)({},e,Object(M.a)({},t.name,{value:a,fieldValid:{valid:n}}))},{})}},a.handleFieldChange=function(e){a.setState({fields:Object(b.a)({},a.state.fields,Object(M.a)({},e.fieldName,e))})},a.handleChangeMulti=function(e){var t,n=a.props.referenceTables.ricentities,r=e?(t=e,Object(p.orderBy)(t,[function(e){return e.value.toLowerCase()}],["asc"]).map(function(e){return e.value}).join(" & ")):"",i=e||[],o=e?function(e,t){var a=e.map(function(e){return t.find(function(t){return t.RICname===e.value}).continent});return a.length>1?"World":1===a.length?a[0]:null}(i,n):null;a.setState({multiParts:i,fields:Object(b.a)({},a.state.fields,{RICname:{fieldName:"RICname",value:r,fieldValid:{valid:""!==r,error:""===r?{message:"field is required"}:null}},continent:{fieldName:"continent",value:o,fieldValid:{valid:""!==o,error:""===o?{message:"field is required"}:null}}})})},a.state=a.getStateFromProps(),a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this,t=this.props,a=t.resourceDescriptor,n=t.referenceTables,i=a.schema,o=Object(p.values)(this.state.fields).filter(function(e){return e.fieldValid&&!e.fieldValid.valid}),l=Object(p.sortBy)(i.fields,function(e){return Be[e.name]}),s=Ve({tables:n,resourceName:"ricentities",referenceField:"RICname",filter:{field:"type",value:"group"}});return r.a.createElement("div",null,r.a.createElement("div",{style:{height:"40vh",overflow:"auto"}},r.a.createElement("h3",null,'New row to "',a.name,'" table'),l.map(function(t,a){if("RICname"===t.name){var i=e.state.fields[t.name],o=i.value,l=i.fieldValid;return r.a.createElement(h.Field,null,r.a.createElement(h.Label,null,t.name,t.constraints&&t.constraints.required&&r.a.createElement("span",null,"*")),r.a.createElement(h.Control,null,r.a.createElement(ke.a,{isSearchable:!0,isClearable:!0,isMulti:!0,value:e.state.multiParts,options:s,onChange:e.handleChangeMulti}),r.a.createElement("div",null,o)),l&&l.error&&r.a.createElement(h.Help,{isColor:"danger"},l.error.message))}return r.a.createElement(De,{key:a,isNonchangable:"RICname"!==t.name,referenceTables:n,fieldDescriptor:t,fieldValue:e.state.fields[t.name].value,onChange:e.handleFieldChange})})),r.a.createElement(h.Field,{isGrouped:!0},r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",onClick:this.props.onCancel},"Cancel")),r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",isDisabled:o.length>0,onClick:function(){var t={newResource:{resourceName:a.name,data:[Object(p.mapValues)(e.state.fields,function(e){return e.value||""})]},newReference:{resourceName:"ricentities_groups",data:e.state.multiParts.map(function(t){return{RICname_group:e.state.fields.RICname.value,RICname_part:t.value}})}};e.props.onAddNew(t)}},"Add new"))))}}]),t}(r.a.Component),Pe=function(e){return Object(p.mapValues)(e,function(e){return e.value})},He=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).getStateFromProps=function(){var e=a.props,t=e.resourceDescriptor,n=e.originalValues,r=e.prefixedValues;return{newResource:t.schema.fields.reduce(function(e,t){var a="",i=!0;return t.constraints&&t.constraints.required&&(i=!1),n&&n.find(function(e){return e.referenceField===t.name})&&"slug"!==t.name&&(a=n.find(function(e){return e.referenceField===t.name}).value,i=!0),r&&r[t.name]&&(a=r[t.name],i=!0),Object(b.a)({},e,Object(M.a)({},t.name,{value:a,fieldValid:{valid:i}}))},{}),showNewReference:!1}},a.getSlug=function(e){var t=Object(b.a)({},a.state.newResource,Object(M.a)({},e.fieldName,e));return{fieldName:"slug",value:Q(Pe(t))}},a.handleFieldChange=function(e){var t=a.props.resourceDescriptor;if(a.state.newResource.slug){var n=a.getSlug(e);a.setState({newResource:Object(b.a)({},a.state.newResource,Object(M.a)({slug:n},e.fieldName,e))})}else"ricentities"===t.name&&"type"===e.fieldName&&"group"===e.value&&a.props.onSelectGroup(),a.setState({newResource:Object(b.a)({},a.state.newResource,Object(M.a)({},e.fieldName,e))})},a.handleShowNew=function(e){a.setState({showNewReference:!0})},a.handleHideNew=function(){var e=a.state.referenceMap.field;a.setState({showNewReference:!1,newReference:null,referenceMap:null,isRICentityGroup:!1,prefixedValues:null,newResource:Object(b.a)({},a.state.newResource,Object(M.a)({},e,{fieldValid:{valid:!1},value:""}))})},a.handleCreateNewReference=function(e){var t=e.referenceMap,n=t.field;a.setState({showNewReference:!0,resourceValid:{valid:!0},referenceMap:t,newReference:null,newResource:Object(b.a)({},a.state.newResource,Object(M.a)({},n,{fieldValid:{valid:!1},value:""}))})},a.handleAddNewReference=function(e){var t=e.newResource,n=e.newReference,r=a.state.referenceMap,i=r.field,o=r.referenceField;a.setState({newReference:t,newRefReference:n,showNewReference:!1,newResource:Object(b.a)({},a.state.newResource,Object(M.a)({},i,{fieldValid:{valid:!0},value:t.data[0][o]}))})},a.handleResetNewReference=function(){var e=a.state.referenceMap.field;a.setState({newReference:null,newRefReference:null,showNewReference:!0,newResource:Object(b.a)({},a.state.newResource,Object(M.a)({},e,{fieldValid:{valid:!1},value:""}))})},a.handleSelectGroup=function(){a.setState({isRICentityGroup:!0})},a.state=a.getStateFromProps(),a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this,a=this.props,n=a.descriptor,i=a.resourceDescriptor,o=a.referenceTables,l=a.originalValues,s=a.prefixedValues,c=i.schema,u=Object(p.values)(this.state.newResource).filter(function(e){return e.fieldValid&&!e.fieldValid.valid}),d=function(){if(c.foreignKeys){var e=c.foreignKeys[0].reference;return n.resources.find(function(t){return t.name===e.resource})}},f=function(){var t=Object(L.a)(D.a.mark(function t(){var a,n,r,l,s,u,d;return D.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a={newResource:{resourceName:i.name,data:[Object(p.mapValues)(e.state.newResource,function(e){return e.value||""})]},newReference:e.state.newReference,newRefReference:e.state.newRefReference},"currencies"!==i.name||e.state.newReference){t.next=22;break}return n=[Object(p.keys)(a.newResource.data[0])].concat([Object(p.values)(a.newResource.data[0])]),r={exchange_rates:o.exchange_rates},s={modified_currency:e.state.newResource.modified_currency.value},t.prev=5,t.next=8,P.Table.load(n,{schema:c});case 8:return l=t.sent,t.next=11,l.read({forceCast:!0,relations:r});case 11:u=t.sent,(d=u.filter(function(e){return e.errors})).length?e.setState({prefixedValues:s,resourceValid:{valid:!1,message:d[0].errors[0].errors[0].message}}):(e.setState({resourceValid:{valid:!0}}),e.props.onAddNew(a)),t.next=20;break;case 16:t.prev=16,t.t0=t.catch(5),e.setState({prefixedValues:s,resourceValid:{valid:!1,message:t.t0.message||"validation fail"}}),console.error(t.t0);case 20:t.next=23;break;case 22:e.props.onAddNew(a);case 23:case"end":return t.stop()}},t,null,[[5,16]])}));return function(){return t.apply(this,arguments)}}();return r.a.createElement("div",null,r.a.createElement(h.Columns,null,r.a.createElement(h.Column,{style:{height:"50vh",overflow:"auto"}},r.a.createElement("h3",null,'New row to "',i.name,'" table'),Object(p.sortBy)(c.fields,function(e){return e.constraints&&e.constraints.required}).map(function(t,a){var n;return"sources"===i.name&&-1!==z.indexOf(t.name)&&(n=Object(p.uniq)(o.sources.map(function(e){return e[t.name]}))),r.a.createElement(De,{key:a,isNonchangable:-1!==K.indexOf(t.name)||s&&s[t.name],isValidationField:e.state.prefixedValues&&e.state.prefixedValues[t.name],fieldDescriptor:t,foreignKeys:c.foreignKeys,referenceTables:o,suggestedOptions:n,fieldValue:e.state.newResource[t.name]&&e.state.newResource[t.name].value||s&&s[t.name],showNewReference:e.state.showNewReference,newReference:e.state.newReference,onClickCreate:e.handleCreateNewReference,onChange:e.handleFieldChange})}),this.state.resourceValid&&this.state.resourceValid.message&&r.a.createElement(h.Field,null,r.a.createElement(h.Help,{isColor:"danger"},this.state.resourceValid.message))),c.foreignKeys&&r.a.createElement(h.Column,null,this.state.showNewReference&&(this.state.isRICentityGroup?r.a.createElement(Ue,{descriptor:n,resourceDescriptor:d(),referenceTables:o,onCancel:this.handleHideNew,onAddNew:this.handleAddNewReference}):r.a.createElement(t,{descriptor:n,originalValues:l.filter(function(e){return"year"===e.field}),resourceDescriptor:d(),referenceTables:o,prefixedValues:this.state.prefixedValues,onSelectGroup:this.handleSelectGroup,onCancel:this.handleHideNew,onAddNew:this.handleAddNewReference})),this.state.newReference&&r.a.createElement("div",null,r.a.createElement(Me,{resource:this.state.newReference}),r.a.createElement(h.Button,{onClick:this.handleResetNewReference},"Reset"))),c.foreignKeys&&this.state.newRefReference&&r.a.createElement(h.Column,null,r.a.createElement(Me,{resource:this.state.newRefReference}))),r.a.createElement(h.Field,{isGrouped:!0},r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",onClick:this.props.onCancel},"Cancel")),r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",isDisabled:u.length>0,onClick:f},"Add new"))))}}]),t}(r.a.Component),Ge=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).initFixedValues=function(){return a.props.modificationItem.field.split("|").reduce(function(e,t){return Object(b.a)({},e,Object(M.a)({},t,void 0))},{})},a.hydrateState=function(){var e=a.props.modificationItem,t=a.initFixedValues();return e.fixedValues&&(t=e.fixedValues),{fixedValues:t,showNewForm:!1,newResource:null,newReference:null,newRefReference:null,showSolving:!e.fixed}},a.handleSubmitForm=function(){var e=a.state,t=e.fixedValues,n=e.newResource,r=e.newReference,i=e.newRefReference,o=[];n&&o.push(n),r&&o.push(r),i&&o.push(i),a.props.onSubmitForm({fixedValues:t,fixedReferenceTable:o})},a.handleClickCreate=function(){a.props.onTouch(!0);var e=a.initFixedValues();a.setState({fixedValues:e,showSolving:!0,showNewForm:!0,newResource:null,newReference:null,newRefReference:null})},a.handleResetCreate=function(){a.setState({showNewForm:!0,newResource:null,newReference:null})},a.handleAddNewResource=function(e){var t=e.newResource,n=e.newReference,r=e.newRefReference,i=a.props,o=i.modificationItem,l=i.foreignKeyField,s=o.field.split("|"),c=s.reduce(function(e,a,n){var r=s.length>1?t.data[0][l.reference.fields[n]]:t.data[0][l.reference.fields],i=G[a];return i&&i in t.data[0]&&(r=t.data[0][i]),Object(b.a)({},e,Object(M.a)({},a,r))},{});a.setState({newResource:t,newReference:n,newRefReference:r,fixedValues:c,showNewForm:!1})},a.handleCancel=function(){a.setState({showNewForm:!1,newResource:null,newReference:null,newRefReference:null})},a.handleSelectExist=function(e){var t=a.props.modificationItem;a.props.onTouch(!0),e?a.setState({fixedValues:Object(M.a)({},t.field,e.value),newResource:null}):a.setState({fixedValues:Object(M.a)({},t.field,"")})},a.handleShowSolving=function(){a.props.onTouch(!0);var e=a.initFixedValues();a.setState({fixedValues:e,showSolving:!0,newResource:null,newReference:null,newRefReference:null})},a.handleHideSolving=function(){a.props.onTouch(!1),a.setState({showSolving:!1,showNewForm:!1,newResource:null,newReference:null,newRefReference:null})},a.handleDiscard=function(){var e=a.props.modificationItem;a.props.onTouch(!1);var t=a.initFixedValues();a.setState({fixedValues:t,showSolving:!e.fixed,showNewForm:!1,newResource:null,newReference:null,newRefReference:null}),a.props.onDiscard()},a.state=a.hydrateState(),a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"componentDidUpdate",value:function(e){if(this.props.modificationIndex!==e.modificationIndex){var t=this.hydrateState();this.setState(Object(b.a)({},t))}}},{key:"renderFixed",value:function(){var e=this.props.modificationItem,t=e.field,a=e.fixedValues,n=e.fixedReferenceTable,i=e.unchangable,o=e.fixedStatus,l=Object(p.values)(a).join("|"),s=l.length?l:"none",c=Object(p.difference)(K,t.split("|")).length<K.length;return r.a.createElement(h.Field,null,r.a.createElement(h.Control,null,r.a.createElement(h.Label,{className:"has-text-success"},"Fixed with value"),r.a.createElement("p",{className:"has-text-success"},s),r.a.createElement(h.Help,{isColor:"success"},!c&&r.a.createElement("li",null,"total ",e.errors.length," rows updated"),n&&n.map(function(e,t){return r.a.createElement("li",{key:t},e.data.length,' row(s) added to "',e.resourceName,'" table')})),!this.state.showSolving&&r.a.createElement(h.Button,{isColor:"info",isDisabled:i,onClick:this.handleShowSolving},"Change this fix"),i&&"fixInOther"===o&&r.a.createElement(h.Help,{isColor:"success"},"found same value in other error, please fix it there"),i&&"autoFixed"===o&&r.a.createElement(h.Help,{isColor:"success"},"this foreign key error is auto fixed by previous format modification")))}},{key:"renderSolving",value:function(){var e=this.props,t=e.modificationItem,a=e.referenceTables,n=e.isCurrencyFixDisabled,i=e.schema,o=i.fields.find(function(e){return e.name===t.field});return r.a.createElement("div",null,"source"===t.field&&!this.state.showNewForm&&!this.state.newResource&&r.a.createElement(De,{isNonchangable:!1,foreignKeys:i.foreignKeys,fieldDescriptor:o,referenceTables:a,fixedValue:this.state.fixedValues[t.field],fieldValue:this.state.fixedValues[t.field],onClickCreate:this.handleClickCreate,onChange:this.handleSelectExist}),"source"!==t.field&&r.a.createElement(h.Field,null,r.a.createElement(h.Control,null,n&&r.a.createElement(h.Help,{isColor:"danger"},"Please fix year format error first"),r.a.createElement(h.Button,{isDisabled:n,isColor:"info",onClick:this.handleClickCreate},"Create new item"))))}},{key:"render",value:function(){var e=this,t=this.props,a=t.modificationItem,n=t.foreignKeyField,i=t.descriptor,o=t.referenceTables,l=t.isModificationTouched,s=a.value,c=a.message,u=a.field,d=n.reference.resource,f=i.resources.find(function(e){return e.name===d}),m=function(e,t){return e.split("|").map(function(e,a){return{value:t.split("|")[a],field:e,referenceField:"string"===typeof n.reference.fields?n.reference.fields:n.reference.fields[a]}})}(u,s),b=function(e){switch(e){case"reporting":case"partner":case"currency|year|reporting":return"1/4";default:return"1/2"}}(a.field),v=u.split("|").length>0?Object(p.values)(e.state.fixedValues).filter(function(e){return void 0===e}).length>0:void 0===e.state.fixedValues[u];return r.a.createElement("div",{style:{height:"60vh"}},r.a.createElement("form",null,r.a.createElement(h.Columns,null,r.a.createElement(h.Column,{isSize:b},r.a.createElement(h.Field,null,r.a.createElement(h.Label,null,'Original value of "',u,'":'),r.a.createElement("div",{className:"has-text-danger"},s),r.a.createElement(h.Help,{isColor:"danger"},c)),!this.state.showSolving&&a.fixed&&this.renderFixed(),this.state.showSolving&&this.renderSolving()),this.state.showNewForm&&r.a.createElement(h.Column,{className:"new-resource-form",style:{flex:"auto"}},r.a.createElement(He,{originalValues:m,descriptor:i,resourceDescriptor:f,referenceTables:o,onCancel:this.handleCancel,onAddNew:this.handleAddNewResource})),this.state.newResource&&r.a.createElement(h.Column,null,r.a.createElement(Me,{resource:this.state.newResource}),r.a.createElement(h.Button,{onClick:this.handleClickCreate},"Reset")),this.state.newReference&&r.a.createElement(h.Column,null,r.a.createElement(Me,{resource:this.state.newReference})),this.state.newRefReference&&r.a.createElement(h.Column,null,r.a.createElement(Me,{resource:this.state.newRefReference}))),this.state.showSolving&&r.a.createElement(h.Field,{isGrouped:!0},l&&r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",onClick:this.handleDiscard},"Discard modification")),r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",isDisabled:v,onClick:this.handleSubmitForm},"Confirm this fix")))))}}]),t}(r.a.Component),Ke=Object(l.b)(null,{validateResource:function(e){return function(t){var a=e.descriptor;t(Object(L.a)(D.a.mark(function e(){var n;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=U.Resource.load(a),e.next=4,n.read();case 4:t({type:"VALIDATE_RESOURCE_SUCCESS",payload:{valid:!0}}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),console.error(e.t0),e.t0.multiple?t({type:"VALIDATE_RESOURCE_FAILURE",payload:{rowNumber:e.t0.rowNumber,messages:e.t0.errors.map(function(e){return Object(b.a)({},e,{message:e.message})})}}):t({type:"VALIDATE_RESOURCE_FAILURE",payload:{rowNumber:e.t0.rowNumber,messages:[Object(b.a)({},e.t0,{message:e.t0.message})]}});case 11:case"end":return e.stop()}},e,null,[[0,7]])})))}}})(Ge),We=Object(l.b)(function(e){return{descriptor:e.schemaValidation.descriptor,referenceTables:e.referenceTables.referenceTables}})(function(e){e.className;var t=e.flows,a=e.referenceTables,n=e.descriptor,i=e.schema,o=e.isCurrencyFixDisabled,l=e.isModificationTouched,s=e.modificationItem,c=e.modificationIndex,u=e.onDiscard,d=e.onTouch,f=e.onSubmitModification,m=function(e){var t=e.fixedValues,a=e.fixedReferenceTable;return f(Object(b.a)({},s,{fixedValues:t,fixedReferenceTable:a,index:c}))};return r.a.createElement("div",null,"ERROR_FORMAT"===s.errorType&&r.a.createElement(Le,{fieldDescriptor:function(){var e=s.field;return i.fields.find(function(t){return t.name===e})}(),modificationItem:s,modificationIndex:c,isModificationTouched:l,onDiscard:u,onTouch:d,onSubmitForm:m}),"ERROR_FOREIGN_KEY"===s.errorType&&r.a.createElement(Ke,{schema:i,descriptor:n,foreignKeyField:function(){var e;if(-1!==s.field.indexOf("|")){var t=s.field.split("|");e=i.foreignKeys.find(function(e){return Object(p.isEqual)(e.fields,t)})}else e=i.foreignKeys.find(function(e){return e.fields===s.field});return e}(),isCurrencyFixDisabled:o,isModificationTouched:l,referenceTables:a,modificationItem:s,modificationIndex:c,onDiscard:u,onTouch:d,onSubmitForm:m}),r.a.createElement(Te,{flows:t,modificationItem:s}))}),qe=function(e){var t=e.isActive,a=e.closeModal;return r.a.createElement(h.Modal,{isActive:t},r.a.createElement(h.ModalBackground,{onClick:a}),r.a.createElement(h.ModalContent,null,r.a.createElement(h.Card,{bodyContent:"You have made a modification, please confirm your fix first?"})),r.a.createElement(h.ModalClose,{onClick:a}))},Qe=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).handleTouchModification=function(e){a.setState({isModificationTouched:e})},a.handleShowAlert=function(){a.setState({showAlert:!0})},a.handleHideAlert=function(){a.setState({showAlert:!1})},a.state={showAlert:!1,isModificationTouched:!1},a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this,t=this.props,a=t.flows,n=t.schema,i=t.isModification,o=t.modificationIndex,l=t.modificationList,c=t.referenceTables,u=t.steps,d=t.selectedStep,f=l.filter(function(e){return!1===e.fixed}),m=l.filter(function(e){return"year"===e.field&&!e.fixed}).map(function(e){return""+e.value}),b=l[o],v=!1;"currency|year|reporting"===b.field&&-1!==m.indexOf(b.value.split("|")[1])&&(v=!0);return r.a.createElement("div",null,!i&&r.a.createElement("div",null,l.length>0&&r.a.createElement("div",{className:"has-text-danger has-text-weight-bold"},l.length," different errors need to modify"),l&&r.a.createElement(je,{modificationList:l,onSelectError:function(t){t<l.length&&e.props.selectError({index:t})}}),r.a.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},r.a.createElement(h.Button,{isColor:"info",onClick:function(){var t=Object(p.findIndex)(u,d);e.props.setStep(u[t-1])}},"Previous Step"),0===f.length?r.a.createElement(h.Button,{isColor:"info",onClick:function(){var t=Object(p.findIndex)(u,d);e.props.setStep(u[t+1])}},"Ready to publish"):r.a.createElement(h.Button,{isColor:"info",onClick:function(){e.props.selectError({index:f[0].index})}},"Start fix error"))),i&&r.a.createElement("div",null,r.a.createElement(We,{flows:a,schema:n,isCurrencyFixDisabled:v,modificationIndex:o,modificationItem:b,isModificationTouched:this.state.isModificationTouched,onTouch:this.handleTouchModification,onDiscard:function(){o<l.length-1&&f.length>0?e.props.goNextError():e.props.hideModification()},onSubmitModification:function(t){var r=t.errors,i=t.errorType,u=t.fixedReferenceTable;if("ERROR_FORMAT"!==i&&"source"!==t.field||e.props.updateFlows(t),"year"===t.field){var d=r.map(function(e){return e.rowNumber}),m=a[0].indexOf("year"),p=[a[0]].concat(r.map(function(e){var n=Object(s.a)(a[e.rowNumber-1]);return n[m]=t.fixedValues.year,n})),h={currencies:c.currencies};e.props.revalidateRows({originalValue:t.value,fixedValues:t.fixedValues,rowNumbers:d,source:p,schema:n,relations:h})}if("ERROR_FOREIGN_KEY"===i){var v=b.fixedReferenceTable;v&&u&&v.forEach(function(t){e.props.deleteTableRow(t)}),u.forEach(function(t){e.props.addTableRow(t)})}e.props.submitModification(t),e.setState({isModificationTouched:!1}),o<l.length-1&&f.length>0?e.props.goNextError():e.props.hideModification()}}),r.a.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},r.a.createElement("div",null,r.a.createElement(h.Button,{isColor:"info",onClick:function(){e.state.isModificationTouched?e.handleShowAlert():e.props.hideModification()}},"Back to summary")),r.a.createElement("span",{className:"has-text-danger has-text-weight-bold"},o+1," / ",l.length),r.a.createElement("span",null,this.state.showAlert.toString()),r.a.createElement("div",null,0!==o&&r.a.createElement(h.Button,{isColor:"info",style:{marginLeft:"10px"},onClick:function(){e.state.isModificationTouched?e.handleShowAlert():o>0&&e.props.goPrevError()}},"Prev Error"),o!==l.length-1&&r.a.createElement(h.Button,{isColor:"info",style:{marginLeft:"10px"},onClick:function(){e.state.isModificationTouched?e.handleShowAlert():o<l.length-1&&e.props.goNextError()}},"Next Error"))),r.a.createElement(qe,{isActive:this.state.showAlert,closeModal:this.handleHideAlert})))}}]),t}(r.a.Component),ze=Object(l.b)(function(e){return{flows:e.flows.data,referenceTables:e.referenceTables.referenceTables,schema:xe(e),modificationList:e.modification.modificationList,steps:e.ui.steps,selectedStep:e.ui.selectedStep,isModification:e.ui.isModification,modificationIndex:e.modification.modificationIndex}},{setStep:N,updateFlows:function(e){return{type:"UPDATE_FLOWS",payload:e}},addTableRow:function(e){return{type:"ADD_TABLE_ROW",payload:e}},deleteTableRow:function(e){return{type:"DELETE_TABLE_ROW",payload:e}},revalidateRows:function(e){return function(t){var a=e.rowNumbers,n=e.originalValue,r=e.fixedValues,i=e.source,o=e.schema,l=e.relations;t({type:"REVALIDATE_ROWS_REQUEST",payload:Object(b.a)({},e,{status:"loading"})}),t(Object(L.a)(D.a.mark(function e(){var s;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.Table.load(i,{schema:o});case 3:return s=e.sent,e.next=6,s.read({forceCast:!0,relations:l});case 6:e.sent.filter(function(e){return e.errors}).length?t({type:"REVALIDATE_ROWS_FAILURE",payload:{status:"done",valid:!1,rowNumbers:a,originalValue:n,fixedValues:r}}):t({type:"REVALIDATE_ROWS_SUCCESS",payload:{status:"done",valid:!0,rowNumbers:a,originalValue:n,fixedValues:r}}),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(0),console.error(e.t0),t({type:"REVALIDATE_ROWS_FAILURE",payload:{status:"done",valid:!1,error:e.t0}});case 15:case"end":return e.stop()}},e,null,[[0,11]])})))}},hideModification:function(){return{type:S}},selectError:function(e){return{type:j,payload:e}},goNextError:function(){return{type:"GO_NEXT_ERROR"}},goPrevError:function(){return{type:"GO_PREV_ERROR"}},submitModification:function(e){return{type:"SUBMIT_MODIFICATION",payload:e}}})(Qe),Ye=a(64),Je=a.n(Ye),Xe=a(250),Ze=a.n(Xe);function $e(e,t,a){var n,r=e[0];switch(a){case"csv":default:var i=Object(ee.unparse)(e)+"\r\n";n=new File([i],"".concat(t,".").concat(a),{type:"text/csv;charset=utf-8"}),Ze.a.saveAs(n);break;case"xlsx":var o=Je.a.utils.aoa_to_sheet(e,{header:r}),l=Je.a.utils.book_new();Je.a.utils.book_append_sheet(l,o,"SheetJS"),Je.a.writeFile(l,"".concat(t,".").concat(a))}}function et(e,t,a){var n;switch(a){case"csv":default:var r=Object(ee.unparse)(e)+"\r\n";n=new File([r],"".concat(t,".").concat(a),{type:"text/csv;charset=utf-8"}),Ze.a.saveAs(n)}}var tt=a(31),at=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).handleChangeToken=function(e){a.setState({token:e.target.value})},a.handleChangeMessage=function(e){a.setState({message:e.target.value})},a.handleSubmit=function(){a.props.onSubmitAuth(a.state)},a.state={token:"",message:""},a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this.props,t=e.isActive,a=e.isCommit,n=e.closeModal,i=!this.state.token;return a&&(i=!this.state.token||!this.state.message),r.a.createElement(tt.Modal,{isActive:t},r.a.createElement(tt.ModalBackground,{onClick:n}),r.a.createElement(tt.ModalCard,null,r.a.createElement(tt.ModalCardBody,null,r.a.createElement(h.Field,null,r.a.createElement(h.Label,null,"personal access token*:"),r.a.createElement(h.Control,null,r.a.createElement(h.Input,{type:"password",value:this.state.token,onChange:this.handleChangeToken}))),a&&r.a.createElement(h.Field,null,r.a.createElement(h.Label,null,"commit message*:"),r.a.createElement(h.Control,null,r.a.createElement(h.Input,{value:this.state.message,onChange:this.handleChangeMessage}))),r.a.createElement(h.Field,null,i&&r.a.createElement(h.Help,{isColor:"danger"},"requied field is missing"),r.a.createElement(h.Button,{isDisabled:i,isColor:"info",onClick:this.handleSubmit},a?"Commit":"Login")))),r.a.createElement(tt.ModalClose,{onClick:n}))}}]),t}(r.a.Component),nt=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).handleOpenModal=function(){a.setState({isModalShow:!0})},a.handleCloseModal=function(){a.setState({isModalShow:!1})},a.state={isModalShow:!1},a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this,t=this.props,a=t.flows,n=t.repoData,i=t.referenceTables,o=t.originalLength,l=n.selectedBranch,s=n.remoteUpdateStatus,c=n.lastCommit,u=n.remoteUpdateMessage,d=n.tables,f=[];Object.keys(i).forEach(function(e){i[e].length!==o[e]&&f.push({name:e,updatedRows:i[e].slice(o[e])})});var m={};try{var b=Object(p.keyBy)(i.sources,function(e){return e.slug}),v=Object(y.b)(Object(y.a)(a.data));m=Object(p.groupBy)(v,function(e){return t=b[e.source],Object(p.deburr)(q(t,["website"===t.source_category?"editor":"author","name","country","volume_date","volume_number"]));var t})}catch(E){console.log(E),N(2)}return r.a.createElement("div",null,r.a.createElement(h.Columns,null,r.a.createElement(h.Column,null,r.a.createElement("strong",null,"fixed flows table by source"),Object.keys(m).map(function(e){return r.a.createElement("p",null,e,".csv")})),r.a.createElement(h.Column,null,r.a.createElement("div",null,r.a.createElement("strong",null,"updated reference tables"),f.map(function(t){var a=e.props.repoData.descriptor.resources.find(function(e){return e.name===t.name});if(!a)throw new Error("Resource ".concat(t.name," can't be found in descriptor."));var n=a.path.split(".")[0].split("/").slice(-1)[0];return r.a.createElement(h.Control,null,r.a.createElement("a",{href:"#",onClick:function(){et(i[t.name],n,"csv")}},n," table: ",t.updatedRows.length," rows added"))})))),r.a.createElement(h.Field,{isGrouped:!0},r.a.createElement(h.Control,null,r.a.createElement(h.Button,{isColor:"info",onClick:function(){var e=a.file;$e(a.data,"".concat(e.name,"_corrections"),"csv")}},"Download fixed flows")),r.a.createElement(h.Control,null,"updated"===s?r.a.createElement(h.Button,{isColor:"success",onClick:function(){e.props.setStep({id:"0"})}},"Start a new import"):r.a.createElement(h.Button,{isDisabled:"loading"===s,isColor:"info",onClick:this.handleOpenModal},'Publish tables to "',l.name,'" branch'))),r.a.createElement(h.Field,null,"loading"===s&&r.a.createElement(h.Help,{isColor:"success"},"updating files on github: ",u,"..."),"updated"===s&&r.a.createElement(h.Help,{isColor:"success"},"files have been commited on github see"," ",r.a.createElement("a",{href:"https://github.com/".concat(J.c,"/").concat(J.e,"/commit/").concat(c)},"commit details")),"fail"===s&&r.a.createElement(h.Help,{isColor:"danger"},"fail to update files on github")),r.a.createElement(at,{isActive:this.state.isModalShow,isCommit:!0,closeModal:this.handleCloseModal,onSubmitAuth:function(t){e.handleCloseModal();var a=Object.keys(m).map(function(e){return{filePath:"data/flows/".concat(e,".csv"),data:m[e],source:e}}),n=f.map(function(t){var a=e.props.repoData.descriptor.resources.find(function(e){return e.name===t.name});if(!a)throw new Error("Resource ".concat(t.name," can't be found in descriptor."));return{filePath:a.path,data:i[t.name],sha:d[t.name].sha}});e.props.updateRemoteFiles({auth:t,files:a.concat(n),branch:l.name,descriptor:e.props.repoData.descriptor})}}))}}]),t}(r.a.Component),rt=Object(l.b)(function(e){return{flows:e.flows,referenceTables:e.referenceTables.referenceTables,originalLength:e.referenceTables.originalLength,repoData:e.repoData}},{setStep:N,exportFlows:function(e){return{type:"EXPORT_FLOWS"}},updateRemoteFiles:function(e){return function(t){t({type:se});var a=e.files,n=e.branch,r=e.auth,i=e.descriptor,o=new Z.a({token:r.token});t(Object(L.a)(D.a.mark(function e(){var l,s,c,u,d,f,m,p,h,v,E,g,w,O,C,R,x;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.repos(J.c,J.e).fetch();case 3:return l=e.sent,e.next=6,l.git.refs("heads/".concat(n)).fetch();case 6:s=e.sent,c=i.resources.find(function(e){return"flows"===e.name}),u=i.resources.find(function(e){return"flows"===e.group}),d=[],f=!0,m=!1,p=void 0,e.prev=13,h=a[Symbol.iterator]();case 15:if(f=(v=h.next()).done){e.next=43;break}if((E=v.value).sha||!E.filePath.includes("flows")){e.next=35;break}return t({type:ce,payload:"downloading existing flows file ".concat(E.filePath)}),e.prev=19,e.next=22,Object(Y.get)("".concat(J.f,"/").concat(n,"/").concat(E.filePath),{responseType:"text",responseEncoding:"utf8"});case 22:200===(g=e.sent).status&&(E.data=Object(y.b)(g.data).concat(E.data)),e.next=35;break;case 26:if(e.prev=26,e.t0=e.catch(19),!e.t0.response||404!==e.t0.response.status){e.next=32;break}c?c.path.push(E.filePath):u&&((w=Object(b.a)({},u)).path=E.filePath,w.title=E.source,i.resources.push(w)),e.next=35;break;case 32:return console.log(e.t0),t({type:de,error:e.t0}),e.abrupt("return");case 35:return t({type:ce,payload:"uploading ".concat(E.filePath)}),e.next=38,l.git.blobs.create({content:$.Base64.encode(Object(ee.unparse)(E.data)+"\r\n"),encoding:"base64"});case 38:O=e.sent,d.push({path:E.filePath,sha:O.sha,mode:"100644",type:"blob"});case 40:f=!0,e.next=15;break;case 43:e.next=49;break;case 45:e.prev=45,e.t1=e.catch(13),m=!0,p=e.t1;case 49:e.prev=49,e.prev=50,f||null==h.return||h.return();case 52:if(e.prev=52,!m){e.next=55;break}throw p;case 55:return e.finish(52);case 56:return e.finish(49);case 57:return t({type:ce,payload:"uploading datapackage"}),e.next=60,l.git.blobs.create({content:$.Base64.encode(JSON.stringify(i,null,2)),encoding:"base64"});case 60:return C=e.sent,d.push({path:"datapackage.json",sha:C.sha,mode:"100644",type:"blob"}),t({type:ce,payload:"creating tree"}),e.next=66,l.git.trees.create({tree:d,base_tree:s.object.sha});case 66:return R=e.sent,t({type:ce,payload:"creating commit"}),e.next=70,l.git.commits.create({message:r.message||"update data",tree:R.sha,parents:[s.object.sha]});case 70:x=e.sent,s.update({sha:x.sha}),t({type:ue,payload:x.sha}),e.next=79;break;case 75:e.prev=75,e.t2=e.catch(0),console.error(e.t2),t({type:de,err:e.t2});case 79:case"end":return e.stop()}},e,null,[[0,75],[13,45,49,57],[19,26],[50,,52,56]])})))}}})(nt),it=function(e){function t(e){var a;return Object(c.a)(this,t),(a=Object(d.a)(this,Object(f.a)(t).call(this,e))).handleShowLogin=function(){a.setState({isModalShow:!0})},a.handleCloseModal=function(){a.setState({isModalShow:!1})},a.handleLogin=function(e){a.props.loginCreateBranch(e),a.handleCloseModal()},a.state={isModalShow:!1},a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"renderFetchTable",value:function(){var e=this,t=this.props.repoData,a=t.selectedBranch,n=t.tables,i=t.isBranchCreated;return r.a.createElement("div",null,i?r.a.createElement(h.Help,{isColor:"success"},'branch "',a.name,'" is created'):r.a.createElement(h.Help,{isColor:"danger"},"could not get branch from github, try login again"),a&&!n&&r.a.createElement(h.Button,{isColor:"info",onClick:function(){e.props.fetchAllTables({branch:a.name})}},"Fetch table from branch ",a.name),a&&(n?r.a.createElement(h.Help,{isColor:"success"},"tables from ",a.name," branch are loaded"):r.a.createElement(h.Help,{isColor:"danger"},"tables are not loaded, please reload from ",a.name," branch")))}},{key:"render",value:function(){var e=this.props.repoData,t=e.selectedBranch,a=e.isLogined;return r.a.createElement("div",null,!a&&r.a.createElement(h.Button,{isColor:"info",onClick:this.handleShowLogin},r.a.createElement("span",null,"Login to get branch")),a&&r.a.createElement(h.Button,{isColor:"info",onClick:this.props.logoutUser},r.a.createElement("span",null,"Logout")),t&&this.renderFetchTable(),r.a.createElement(at,{isActive:this.state.isModalShow,isCommit:!1,closeModal:this.handleCloseModal,onSubmitAuth:this.handleLogin}))}}]),t}(r.a.Component),ot=Object(l.b)(function(e){return{repoData:e.repoData}},{logoutUser:function(){return{type:ie}},loginCreateBranch:function(e){return function(t){t({type:"LOGIN_CREATE_BRANCH_REQUEST",payload:e});var a=e.token,n=new Z.a({token:a});t(Object(L.a)(D.a.mark(function e(){var a,r,i,o,l,s;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.user.fetch();case 3:return a=e.sent,r=a.login,e.next=7,n.repos(J.c,J.e).fetch();case 7:return i=e.sent,e.next=10,i.branches.fetch();case 10:if(o=e.sent,l=o.items.find(function(e){return e.name===r})){e.next=17;break}return s=o.items.find(function(e){return"master"===e.name}),e.next=16,i.git.refs.create({ref:"refs/heads/".concat(r),sha:s.commit.sha});case 16:l=e.sent;case 17:t({type:oe,payload:{name:r,ref:l}}),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(0),console.error(e.t0),t({type:le,payload:{error:e.t0}});case 24:case"end":return e.stop()}},e,null,[[0,20]])})))}},fetchAllTables:function(e){return function(t){var a=e.branch;t({type:"FETCH_DATAPACKAGE_REQUEST"});try{Object(Y.get)("".concat(J.f,"/").concat(a,"/datapackage.json"),{responseType:"json",responseEncoding:"utf8"}).then(function(n){var r=n.data,i=r.resources.filter(function(e){return!e.group&&"flows"!==e.name});t({type:te,payload:r}),t({type:"FETCH_TABLES_REQUEST"}),Promise.all(i.map(function(e){return Object(Y.get)("".concat(J.f,"/").concat(a,"/").concat(e.path),{responseType:"text",responseEncoding:"utf8"}).then(function(t){return Object(b.a)({},e,{data:t.data})})})).then(function(e){var a={};e.forEach(function(e){a[e.name]=e.data}),t({type:ae,payload:a})}).catch(function(a){console.log(a),t({type:ne,payload:e,error:a})})})}catch(n){console.log(n),t({type:"FETCH_DATAPACKAGE_FAILURE",error:n})}}}})(it),lt=function(e){var t,a=e.headerNames,n=e.fieldNames,i=a.length-n.length;t=i>0?Object(p.difference)(a,n):Object(p.difference)(n,a);var o=a.map(function(e,t){return n[t]&&n[t]===e?{name:e,valid:!0}:{name:e,valid:!1}});return r.a.createElement("div",{style:{}},t.length===i&&i>0&&r.a.createElement("div",{className:"has-text-danger"},r.a.createElement("span",null,"Extra headers - "),t.map(function(e){return r.a.createElement("span",null,'"',e,'" ')})),t.length===Math.abs(i)&&i<0&&r.a.createElement("div",{className:"has-text-danger has-text-weight-bold"},r.a.createElement("span",null,"Missing headers - "),t.map(function(e){return r.a.createElement("span",null,'"',e,'" ')})),r.a.createElement("div",{style:{display:"flex",justifyContent:"space-evenly"}},r.a.createElement("div",null,r.a.createElement("div",{className:"has-text-weight-bold"},"headers "),o.map(function(e,t){return r.a.createElement("div",{key:t,className:e.valid?"has-text-black":"has-text-danger"},e.name)})),r.a.createElement("div",null,r.a.createElement("div",{className:"has-text-weight-bold"},"schema fields"),n.map(function(e,t){return r.a.createElement("div",{key:t},e)}))))};var st=function(e,t){var a=t.foreignKeys.map(function(e){return Array.isArray(e.fields)?e.fields:[e.fields]}).reduce(function(t,a){return a.forEach(function(a){if("source"!==a){var n=e[0].indexOf(a);t.includes(n)||t.push(n)}}),t},[]);return e.map(function(e,t){return 0!==t?e.map(function(e,t){return a.includes(t)&&e.toLowerCase?e.toLowerCase().trim():e}):e})},ct=Object(l.b)(function(e){return{steps:e.ui.steps,selectedStep:e.ui.selectedStep,schema:e.repoData.descriptor&&xe(e),flows:e.flows,tables:e.repoData.tables,headerFeedback:e.schemaValidation.headerFeedback}},{importFlows:function(e){return{type:"IMPORT_FLOWS",payload:e}},setStep:N,validateHeader:function(e){return function(t){var a=e.source,n=e.schema;t({type:be,payload:Object(b.a)({},e,{status:"loading"})}),t(Object(L.a)(D.a.mark(function e(){var r;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.Table.load(a.slice(0,2),{schema:n});case 3:return r=e.sent,e.next=6,r.read({limit:1});case 6:t({type:ve,payload:{status:"done",valid:!0,headers:r.headers}}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error(e.t0),"ERROR_HEADER"!==e.t0.type?t({type:ve,payload:{status:"done",valid:!0,headers:r.headers}}):t({type:Ee,valid:!1,status:"done",payload:e.t0});case 13:case"end":return e.stop()}},e,null,[[0,9]])})))}}})(function(e){var t=e.steps,a=e.selectedStep,n=e.schema,i=e.tables,o=e.flows,l=e.headerFeedback,s=e.setStep,c=e.importFlows,u=e.validateHeader;return r.a.createElement("div",null,r.a.createElement(ot,null),i&&r.a.createElement(h.DropZone,{maxSize:1e7,onDrop:function(e){var t=Object(Ae.a)(e,1)[0];"xlsx"===t.name.split(".")[1]?function(e){return new Promise(function(t,a){var n=new FileReader;n.onload=function(e){var a=e.target.result,r=Je.a.read(a,{type:"binary"}),i=r.SheetNames[0],o=r.Sheets[i],l=Je.a.utils.sheet_to_json(o,{header:1,defval:"",blankrows:!1});t(l),n=void 0},n.onerror=function(e){a(e.target.error),n=void 0},n.readAsBinaryString(e)})}(t).then(function(e){e=st(e,n),c({file:{name:t.name.split(".")[0]},data:e}),u({source:e,schema:n})}).catch(function(e){console.error(e),console.error("fail to parse file")}):function(e){return new Promise(function(t,a){var n=new FileReader;return n.onload=function(a){var r;r="csv"===e.name.split(".")[1]?Object(y.c)(a.target.result):Object(y.d)(a.target.result),t(r),n=void 0},n.onerror=function(e){a(e.target.error),n=void 0},n.readAsText(e)})}(t).then(function(e){e=st(e,n),c({file:{name:t.name},data:e}),u({source:e,schema:n})}).catch(function(e){console.error(e),console.error("fail to parse file")})},onDropRejected:function(e,t){console.log("file is invalid")},isSize:"small"},r.a.createElement("span",{className:"tech-info"},"Cick here to upload or drag and drop .xlsx, .csv file here(maximum 10MB)")),l&&"loading"===l.status&&r.a.createElement("span",null,"Validating Headers"),l&&l.valid&&r.a.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},r.a.createElement("span",{className:"has-text-success has-text-weight-bold"},'Headers of "',o.file.name,'" are valid'),r.a.createElement(h.Button,{isColor:"info",onClick:function(){var e=Object(p.findIndex)(t,a);s(t[e+1])}},"Next Step")),l&&!l.valid&&"ERROR_HEADER"===l.type&&r.a.createElement("div",{style:{textAlign:"center"}},r.a.createElement("span",{className:"has-text-danger has-text-weight-bold"},'Headers of "',o.file.name,'" do not match schema fields, please fix your file and re-upload'),r.a.createElement(lt,{headerNames:l.headerNames,fieldNames:l.fieldNames})))}),ut=function(e){var t=e.className,a=e.collectedErrors,n=["Field","Error Type","Error Overview"],i=Object(p.sortBy)(a,function(e){return H[e.name]});return r.a.createElement("div",{style:{position:"relative",width:"100%",height:"70vh"}},r.a.createElement("div",{className:"action-table ".concat(t)},r.a.createElement("div",{className:"action-table-header"},n.map(function(e,t){return r.a.createElement("div",{key:t,className:"table-cell"},e)})),r.a.createElement("div",{className:"action-table-main"},i.map(function(e,t){var a=e.errors.length,i=Object(p.groupBy)(e.errors,function(e){return e.value}),o=Object.keys(i).length;return r.a.createElement("div",{key:t,className:"table-row"},n.map(function(t,n){var i=[];return"ERROR_FORMAT"!==e.errorType||"reporting"!==e.name&&"partner"!==e.name||(i=e.errors.map(function(e){return e.rowNumber})),0===n?r.a.createElement("div",{key:n,className:"table-cell"},e.name):1===n?r.a.createElement("div",{key:n,className:"table-cell"},e.errorType):r.a.createElement("div",{key:n,className:"table-cell"},r.a.createElement("span",null,o," different invalid values, ",a," rows affected in total"),i.map(function(e){return r.a.createElement("li",{className:"has-text-danger"},"missing value in row ",e)}))}))}))))},dt=function(e){function t(){return Object(c.a)(this,t),Object(d.a)(this,Object(f.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(u.a)(t,[{key:"componentDidMount",value:function(){var e=this.props,t=e.flows,a=e.schema,n=e.relations;e.schemaFeedback||this.props.validateTable({source:t,schema:a,relations:n})}},{key:"render",value:function(){var e=this,t=this.props,a=t.schemaFeedback,n=t.modificationList,i=t.steps,o=t.selectedStep,l=!1;a&&a.collectedErrors&&(l=a.collectedErrors.reporting&&"ERROR_FORMAT"===a.collectedErrors.reporting.errorType||a.collectedErrors.partner&&"ERROR_FORMAT"===a.collectedErrors.partner.errorType);return r.a.createElement("div",null,a&&"loading"===a.status&&r.a.createElement("span",null,a.loader),r.a.createElement("div",null,a&&!a.valid&&a.collectedErrors&&r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"has-text-danger has-text-weight-bold"},"Found errors in ",a.errors.length," rows of"," ",Object.keys(a.collectedErrors).length," fields",l&&r.a.createElement("span",null,", value of required field is missing, please fix it locally first")),r.a.createElement(ut,{collectedErrors:a.collectedErrors})),a&&a.valid&&r.a.createElement("span",{className:"has-text-success has-text-weight-bold"},"Flows data is valid"),r.a.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},r.a.createElement(h.Button,{isColor:"info",onClick:function(){var t=Object(p.findIndex)(i,o);e.props.setStep(i[t-1])}},"Previous Step"),a&&!a.valid&&a.collectedErrors&&r.a.createElement(h.Button,{isColor:"info",isDisabled:l,onClick:function(){if(!n){var t=function(e){var t=Object(p.values)(e).reduce(function(e,t){return e.concat(t.errors)},[]),a=Object(p.values)(Object(p.groupBy)(t,function(e){return e.field+e.value})).map(function(e,t){return{index:t,field:e[0].field,errorType:e[0].errorType,fixed:!1,message:e[0].message.replace(Re,"".concat(e.length," rows")),originalValue:e[0].value,value:e[0].value,errors:e}});return Object(p.sortBy)(a,function(e){return H[e.name]})}(a.collectedErrors);e.props.startModification(t)}var r=Object(p.findIndex)(i,o);e.props.setStep(i[r+1])}},"Review Errors"),a&&a.valid&&r.a.createElement(h.Button,{isColor:"info",isDisabled:l,onClick:function(){return e.props.setStep(i[3])}},"Publish"))))}}]),t}(r.a.Component),ft=Object(l.b)(function(e){return{steps:e.ui.steps,selectedStep:e.ui.selectedStep,flows:e.flows.data,schema:xe(e),relations:Se(e),schemaFeedback:e.schemaValidation.schemaFeedback,modificationList:e.modification.modificationList}},{validateTable:function(e){return function(t){var a=e.source,n=e.schema,r=e.relations;t(Object(L.a)(D.a.mark(function e(){var i,o,l,s,c,u,d,f,m,h,b,v,E,g,w,y,O,C,R,x,S;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,i=a.length,o=100,l=[],s=a[0],c=Object(p.chunk)(a.slice(1),o),u=0,d=!0,f=!1,m=void 0,e.prev=11,h=c[Symbol.iterator]();case 13:if(d=(b=h.next()).done){e.next=47;break}return v=b.value,t({type:me,payload:{status:"loading",loader:"validating ".concat(u*o,"/").concat(i-1," rows")}}),e.next=18,P.Table.load([s].concat(v),{schema:n});case 18:return E=e.sent,e.next=21,E.read({forceCast:!0,relations:r});case 21:if(g=e.sent,!(w=g.filter(function(e){return e.errors})).length){e.next=43;break}for(y=!0,O=!1,C=void 0,e.prev=27,R=w[Symbol.iterator]();!(y=(x=R.next()).done);y=!0)(S=x.value).rowNumber=S.rowNumber+o*u,l.push(S);e.next=35;break;case 31:e.prev=31,e.t0=e.catch(27),O=!0,C=e.t0;case 35:e.prev=35,e.prev=36,y||null==R.return||R.return();case 38:if(e.prev=38,!O){e.next=41;break}throw C;case 41:return e.finish(38);case 42:return e.finish(35);case 43:u+=1;case 44:d=!0,e.next=13;break;case 47:e.next=53;break;case 49:e.prev=49,e.t1=e.catch(11),f=!0,m=e.t1;case 53:e.prev=53,e.prev=54,d||null==h.return||h.return();case 56:if(e.prev=56,!f){e.next=59;break}throw m;case 59:return e.finish(56);case 60:return e.finish(53);case 61:l.length?t({type:he,payload:{status:"done",valid:!1,errors:l,collectedErrors:we(a,n,l)}}):t({type:pe,payload:{status:"done",valid:!0}}),e.next=69;break;case 65:e.prev=65,e.t2=e.catch(0),console.error(e.t2),t({type:he,payload:e.t2});case 69:case"end":return e.stop()}},e,null,[[0,65],[11,49,53,61],[27,31,35,43],[36,,38,42],[54,,56,60]])})))}},setStep:N,startModification:function(e){return{type:E,payload:e}}})(dt),mt=function(e){var t=e.steps,a=e.selectedStep,n=e.onSetStep,i=e.children;return r.a.createElement(h.LayoutWrapper,{hasConfig:!0},r.a.createElement(h.LayoutHeader,null,r.a.createElement(h.AppTitle,null,"Ricardo Data App"),r.a.createElement(h.RunningTitle,null,a.title)),r.a.createElement(h.LayoutContainer,null,r.a.createElement(h.LayoutContent,null,r.a.createElement(h.LayoutContentColumn,{isConfig:!0},t.map(function(e,t){var i=a.id===e.id,o=e.id>a.id;return r.a.createElement(h.ButtonContainer,{key:t},r.a.createElement(h.Button,{isColor:i?"info":null,isDisabled:o,onClick:function(){return n(e)}},e.name))})),r.a.createElement(h.LayoutContentColumn,{isWorkspace:!0},i)),r.a.createElement(h.LayoutFooter,null,r.a.createElement(h.LayoutFooterColumn,{isSecondary:!0},r.a.createElement("h3",null,"m\xe9dialab SciencesPo")),r.a.createElement(h.LayoutFooterColumn,{isPrimary:!0},"Ricardo Data App"))))},pt=(a(1162),a(1163),function(e){var t=e.originalLength,a=e.referenceTables,n=e.onSelectDiscard,i=e.onSelectDownload,o=e.isActive,l=e.closeModal,s=[];return a&&Object.keys(a).forEach(function(e){a[e].length!==t[e]&&s.push({name:e,updatedRows:a[e].slice(t[e])})}),r.a.createElement(tt.Modal,{isActive:o},r.a.createElement(tt.ModalBackground,{onClick:l}),r.a.createElement(tt.ModalCard,null,r.a.createElement(tt.ModalCardBody,null,r.a.createElement("div",{style:{textAlign:"center"}},r.a.createElement("h5",{className:"title is-5"},"Leave this step, you might lost your modification?"),s.length>0&&r.a.createElement("p",null,"updated reference tables"),s.map(function(e,t){return r.a.createElement("div",{key:t},r.a.createElement("a",{href:"#",onClick:function(){et(a[e.name],e.name,"csv")}},e.name," table: ",e.updatedRows.length," rows added"))}),r.a.createElement(h.Field,{isGrouped:!0},r.a.createElement(h.Control,null,r.a.createElement(h.Button,{onClick:i,isColor:"success"},"Download fixed flows")),r.a.createElement(h.Control,null,r.a.createElement(h.Button,{onClick:n,isColor:"danger"},"Discard")),r.a.createElement(h.Control,null,r.a.createElement(h.Button,{onClick:l,isColor:"info"},"Cancel")))))),r.a.createElement(tt.ModalClose,{onClick:l}))}),ht=Object(l.b)(function(e){return{steps:e.ui.steps,isModalDisplay:e.ui.isModalDisplay,flows:e.flows,referenceTables:e.referenceTables.referenceTables,originalLength:e.referenceTables.originalLength,selectedStep:e.ui.selectedStep,modificationList:e.modification.modificationList,repoData:e.repoData}},{showModal:function(){return{type:T}},hideModal:function(){return{type:k}},setStep:N})(function(e){var t=e.steps,a=e.isModalDisplay,n=e.selectedStep,i=e.repoData,o=e.flows,l=e.referenceTables,s=e.originalLength,c=e.modificationList,u=e.setStep,d=e.showModal,f=e.hideModal;return r.a.createElement("div",{className:"App"},r.a.createElement(mt,{steps:t,selectedStep:n,onSetStep:function(e){var t,a=i.remoteUpdateStatus;c&&(t=c.filter(function(e){return e.fixed})),t&&"0"===e.id&&"updated"!==a?d():u(e)}},function(){switch(n.id){case"0":default:return r.a.createElement(ct,null);case"1":return r.a.createElement(ft,null);case"2":return r.a.createElement(ze,null);case"3":return r.a.createElement(rt,null)}}()),r.a.createElement(pt,{referenceTables:l,originalLength:s,isActive:a,onSelectDiscard:function(){u(t[0])},onSelectDownload:function(){var e=o.file;$e(o.data,"".concat(e.name,"_ongoing_corrections"),"csv")},closeModal:f}))});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var bt=a(20),vt=a(251),Et=a(463),gt=a(161),wt=Object(bt.combineReducers)({ui:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:F,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case x:return Object(b.a)({},F,{selectedStep:_.find(function(e){return a.id===e.id})});case T:return Object(b.a)({},e,{isModalDisplay:!0});case k:return Object(b.a)({},e,{isModalDisplay:!1});case E:return Object(b.a)({},e,{isModification:!0});case S:return Object(b.a)({},e,{isModification:!1});case j:return Object(b.a)({},e,{isModification:!0});default:return e}},flows:I,referenceTables:R,schemaValidation:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ye,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case x:return"0"===a.id?Object(b.a)({},e,{schemaFeedback:null,headerFeedback:null}):e;case te:return Object(b.a)({},e,{descriptor:a});case be:case Ee:case ve:return Object(b.a)({},e,{headerFeedback:a});case me:case he:case pe:return Object(b.a)({},e,{schemaFeedback:a});default:return e}},modification:w,repoData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fe,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case ie:return Object(b.a)({},e,{isLogined:!1,tables:null,selectedBranch:null,isBranchCreated:!1});case O:return Object(b.a)({},e,{tables:null,remoteUpdateStatus:null});case ae:return Object(b.a)({},e,{tables:a});case ne:return Object(b.a)({},e,{tables:null});case te:return Object(b.a)({},e,{descriptor:a});case re:return Object(b.a)({},e,{branches:a.branches});case oe:return Object(b.a)({},e,{isLogined:!0,selectedBranch:a,isBranchCreated:!0});case le:return Object(b.a)({},e,{isLogined:!1,selectedBranch:null,isBranchCreated:!1});case se:return Object(b.a)({},e,{remoteUpdateStatus:"loading",lastCommit:null,remoteUpdateMessage:null});case ce:return Object(b.a)({},e,{remoteUpdateStatus:"loading",remoteUpdateMessage:a});case ue:return Object(b.a)({},e,{remoteUpdateStatus:"updated",lastCommit:a});case de:return Object(b.a)({},e,{remoteUpdateStatus:"fail"});default:return e}}}),yt={key:"root",storage:Et},Ot=Object(vt.a)(yt,wt);var Ct=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=[gt.a],a=bt.compose.apply(void 0,[bt.applyMiddleware.apply(void 0,t)].concat([])),n=Object(bt.createStore)(Ot,e,a);return{store:n,persistor:Object(vt.b)(n)}}({}).store;o.a.render(r.a.createElement(l.a,{store:Ct},r.a.createElement(ht,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})},40:function(e){e.exports={f:"https://raw.githubusercontent.com/medialab/ricardo_data",a:"https://api.github.com/repos/medialab/ricardo_data/contents",b:"https://api.github.com/repos/medialab/ricardo_data/branches",d:"https://api.github.com/repos/medialab/ricardo_data/git/refs",c:"medialab",e:"ricardo_data"}},451:function(e,t){},466:function(e,t,a){e.exports=a(1165)},476:function(e,t,a){},649:function(e,t){},651:function(e,t){},683:function(e,t){},684:function(e,t){},890:function(e,t,a){var n={"./geojson.json":384,"./table-schema.json":891,"./topojson.json":385};function r(e){var t=i(e);return a(t)}function i(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=i,e.exports=r,r.id=890},959:function(e,t,a){var n={"./data-package.json":960,"./data-resource.json":961,"./fiscal-data-package.json":962,"./registry.json":963,"./tabular-data-package.json":964,"./tabular-data-resource.json":965};function r(e){var t=i(e);return a(t)}function i(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=i,e.exports=r,r.id=959}},[[466,1,2]]]);
//# sourceMappingURL=main.d45c9f84.chunk.js.map